# Obsidian Vertical Tabs 插件功能升级文档

## 概述

本文档记录了 Obsidian Vertical Tabs 插件的所有功能升级和改进内容。

---

## 功能升级历史

### 1. FGroup（父组）系统实现

**版本**: 0.17.4 → 0.17.5

**功能描述**:
- 实现了父组系统（FGroup - Father Group），用于组织和管理标签组
- 允许用户将多个标签组组织到一个可折叠的父组容器中
- 提供了完整的UI交互功能

**主要特性**:
- ✅ 可折叠的FGroup容器，支持展开/收起
- ✅ 显示/隐藏功能，通过眼睛图标控制
- ✅ 拖拽功能，可以重新排列FGroup的顺序
- ✅ 右键菜单支持添加/移除标签组到FGroup
- ✅ FGroup重命名功能
- ✅ 自定义FGroup名称

**相关文件**:
- `src/components/FGroup.tsx` - FGroup组件实现
- `src/components/FGroupNameModal.tsx` - FGroup重命名对话框
- `src/models/ViewState.ts` - FGroup状态管理

---

### 2. FGroup归属问题修复

**版本**: 0.17.5 → 0.17.6

**问题描述**:
- 标签组可以同时属于多个FGroup，导致归属关系混乱
- 缺乏唯一性和排他性约束

**解决方案**:
- 修改 `addGroupToFGroup` 函数，在添加标签组到FGroup前检查是否已属于其他FGroup
- 如果标签组已属于其他FGroup，先从原FGroup中移除
- 确保每个标签组在同一时间只能属于一个FGroup

**代码变更**:
```typescript
// src/models/ViewState.ts
addGroupToFGroup: (fGroupId: Identifier, groupId: Identifier) => {
    const { fGroups } = get();
    const existingFGroupId = findFGroupByGroupId(fGroups, groupId);
    
    if (existingFGroupId && existingFGroupId !== fGroupId) {
        update((state) => {
            const fGroup = state.fGroups.get(existingFGroupId);
            if (fGroup) {
                fGroup.groups = fGroup.groups.filter(id => id !== groupId);
            }
        });
    }
    
    // 添加到新的FGroup
    update((state) => {
        const fGroup = state.fGroups.get(fGroupId);
        if (fGroup) {
            if (!fGroup.groups.includes(groupId)) {
                fGroup.groups.push(groupId);
            }
        }
    });
}
```

---

### 3. 布局调整与显示模式优化

**版本**: 0.17.6 → 0.17.7

**功能描述**:
- 优化了隐藏FGroup时的布局调整
- 实现了固定位置标识系统
- 改进了空容器的处理

**主要改进**:

#### 3.1 自动布局调整
- 当FGroup隐藏时，自动隐藏空的分割容器
- 防止空白区域占用屏幕空间
- 优化了 `autoResizeLayout` 函数

#### 3.2 固定位置标识
- 定义了四个固定位置：
  - `a` = 左上
  - `b` = 左下
  - `c` = 右上
  - `d` = 右下
- 位置标识与标签组的内容无关，只与布局位置相关

#### 3.3 命名约定
- 格式：`默认前缀 + 自定义名称`
- 如果没有自定义名称，只显示默认前缀
- 例如：`a 工作` 或 `a`

**相关文件**:
- `src/services/AutoResizeLayout.ts` - 布局调整服务
- `src/models/VTWorkspace.ts` - 工作区模型
- `src/components/Group.tsx` - 组显示组件

---

### 4. 时间顺序标识系统

**版本**: 0.17.7 → 1.8.0

**功能描述**:
- 实现了基于创建时间的标签组顺序标识
- 使用数字序列 1-8, 9, 0 循环标识
- 每个数字在同一时间只能被一个组使用

**主要特性**:

#### 4.1 数字序列
- 序列：1 → 2 → 3 → 4 → 5 → 6 → 7 → 8 → 9 → 0 → 1（循环）
- 自动分配：创建新组时自动分配下一个可用数字
- 自动释放：关闭组时释放该数字供其他组使用

#### 4.2 双重标识显示
- **位置标识**（固定）：a=左上，b=左下，c=右上，d=右下
- **时间顺序标识**（动态）：按照组别产生的时间顺序

#### 4.3 显示格式
- 有自定义名字：`a 1 自定义名字`
- 无自定义名字：`a 1`

#### 4.4 持久化存储
- 组的创建顺序保存在localStorage中
- 重启Obsidian后仍然保持

**代码实现**:

```typescript
// src/models/ViewState.ts

// 类型定义
export type GroupCreationOrder = DefaultRecord<Identifier, number>;

// 分配组顺序
assignGroupOrder: (id: Identifier) => {
    const { groupCreationOrder } = get();
    const usedOrders = new Set(Object.values(groupCreationOrder).filter((o) => o !== 0));
    const orderSequence = [1, 2, 3, 4, 5, 6, 7, 8, 9, 0];
    
    for (const order of orderSequence) {
        if (!usedOrders.has(order)) {
            set((state) => {
                state.groupCreationOrder.set(id, order);
                saveGroupCreationOrder(state.groupCreationOrder);
                return state;
            });
            return order;
        }
    }
    
    return 1;
},

// 移除组顺序
removeGroupOrder: (id: Identifier) => {
    set((state) => {
        state.groupCreationOrder.delete(id);
        saveGroupCreationOrder(state.groupCreationOrder);
        return state;
    });
}
```

```typescript
// src/components/Group.tsx

// 显示逻辑
const title =
    isSidebar || !group
        ? titleMap[type]
        : (() => {
                const customTitle = groupTitles.get(group.id);
                const defaultPrefix = titleMap[type] || DEFAULT_GROUP_TITLE;
                const order = groupCreationOrder.get(group.id) || 0;
                
                if (customTitle && customTitle !== DEFAULT_GROUP_TITLE && customTitle !== defaultPrefix) {
                    return `${defaultPrefix} ${order} ${customTitle}`;
                }
                return `${defaultPrefix} ${order}`;
            })();
```

```typescript
// src/components/GroupSlot.tsx

// 创建新组时分配顺序
const createLeafNewGroupAndOpen = async () => {
    const leaf = workspace.getLeaf("tab");
    const movedLeaf = await moveTabToNewGroup(app, leaf.id);
    if (!movedLeaf) return;
    assignGroupOrder(movedLeaf.parent.id);
    workspace.setActiveLeaf(movedLeaf, { focus: true });
    lockFocusOnLeaf(app, movedLeaf);
};
```

```typescript
// src/components/Tab.tsx

// 关闭组时移除顺序
menu.addItem((item) => {
    item.setSection("close")
        .setTitle("Close all")
        .setDisabled(isPinned)
        .onClick(() => {
            removeGroupOrder(leaf.parent.id);
            leaf.parent.detach();
        });
});
```

---

## 版本历史

| 版本 | 日期 | 主要更新 |
|------|------|----------|
| 0.17.4 | - | 初始版本 |
| 0.17.5 | - | 实现FGroup系统 |
| 0.17.6 | - | 修复FGroup归属问题 |
| 0.17.7 | - | 布局调整与显示模式优化 |
| 1.8.0 | - | 实现时间顺序标识系统 |

---

## 技术栈

- **框架**: React 19.0.0
- **状态管理**: Zustand 4.5.4
- **拖拽功能**: @dnd-kit/core 6.1.0
- **样式**: SCSS
- **构建工具**: esbuild 0.25.0
- **TypeScript**: 5.6.0

---

## 核心文件结构

```
src/
├── components/
│   ├── FGroup.tsx              # FGroup组件
│   ├── FGroupNameModal.tsx     # FGroup重命名对话框
│   ├── Group.tsx               # 标签组组件
│   ├── GroupSlot.tsx           # 标签组槽位
│   └── Tab.tsx                 # 标签组件
├── models/
│   ├── ViewState.ts            # 视图状态管理
│   └── VTWorkspace.ts          # 工作区模型
├── services/
│   └── AutoResizeLayout.ts     # 自动布局调整服务
└── ...
```

---

## 使用说明

### 创建FGroup
1. 右键点击标签组
2. 选择"添加到FGroup"选项
3. 输入FGroup名称或使用默认名称

### 管理FGroup
- **展开/收起**: 点击FGroup标题栏
- **显示/隐藏**: 点击眼睛图标
- **重命名**: 右键点击FGroup标题栏，选择"重命名"
- **删除**: 右键点击FGroup标题栏，选择"删除"

### 标签组标识说明
- **位置标识**（a/b/c/d）: 表示标签组在屏幕上的固定位置
  - a: 左上
  - b: 左下
  - c: 右上
  - d: 右下
- **时间顺序标识**（1-0）: 表示标签组的创建顺序
  - 按照创建时间顺序分配数字
  - 数字序列：1, 2, 3, 4, 5, 6, 7, 8, 9, 0（循环）

### 显示示例
```
布局：
┌─────────┬─────────┐
│   a 1   │   c 3   │
├─────────┤  工作   │
│   b 2   │         │
└─────────┴─────────┘

说明：
- a 1: 左上位置，第1个创建的组
- b 2: 左下位置，第2个创建的组
- c 3 工作: 右上位置，第3个创建的组，自定义名称为"工作"
```

---

## 已知问题

目前没有已知问题。

---

## 未来计划

- [ ] 支持更多布局模式
- [ ] 添加快捷键支持
- [ ] 优化性能
- [ ] 增加更多自定义选项

---

## 贡献者

- oxdc (作者)

---

## 许可证

MIT License
